using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class peashooterWeapon : MonoBehaviour
{
  /*
  This is the auto target Weapon; the standard weapon our player character will start with
  */
  public GameObject bullet;
  public int damage = 1; //The damage the weapon does on it
  public float firerate = 1; //How often the weapon fires
  public float projectileSpeed = 1f;

  private float reloadTime = 0;

  //Used to find our closestEnemy
  private Enemy closestEnemy = null;
  private float distanceToClosestEnemy = Mathf.Infinity;

  void Update()
  {
    FindClosestEnemy();
    if(closestEnemy != null && reloadTime >= firerate) //In place to prevent instance errors
    {
      Fire();
      reloadTime = 0;
    }
    reloadTime += Time.deltaTime;
  }

  public void Fire()
  {
    GameObject newBullet = Instantiate(bullet, transform.position, Quaternion.identity);
    newBullet.GetComponent<Rigidbody2D>().velocity = closestEnemy.transform.position * projectileSpeed;
  }

  public void FindClosestEnemy()
  {
    Enemy[] allEnemies = GameObject.FindObjectsOfType<Enemy>(); //Draws upon all enemies in the scene

    foreach (Enemy currentEnemy in allEnemies)
    {
      float distanceToEnemy = (currentEnemy.transform.position - this.transform.position).sqrMagnitude;
      if (distanceToEnemy < distanceToClosestEnemy)
      {
        distanceToClosestEnemy = distanceToEnemy;
        closestEnemy = currentEnemy;
      }
    }
    if(closestEnemy != null)
    {
      Debug.DrawLine(this.transform.position, closestEnemy.transform.position);
    }
  }
}
